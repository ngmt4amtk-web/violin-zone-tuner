<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no,viewport-fit=cover">
<title>バイオリン音程練習チューナー</title>
<style>
*{margin:0;padding:0;box-sizing:border-box}
html,body{
  height:100%;
  font-family:-apple-system,BlinkMacSystemFont,'Hiragino Sans',sans-serif;
  background:#0d0f1a;color:#fff;overflow:hidden;
  -webkit-user-select:none;user-select:none;
  -webkit-tap-highlight-color:transparent;
  -webkit-text-size-adjust:100%;
}

/* === Layout === */
#app{display:flex;flex-direction:column;height:100%;padding-top:env(safe-area-inset-top)}
#startScreen{display:flex;flex-direction:column;align-items:center;justify-content:center;flex:1;padding:40px 24px}
#mainApp{display:none;flex-direction:column;flex:1;min-height:0}
#mainApp.visible{display:flex}
.header{text-align:center;padding:12px 16px;font-size:16px;font-weight:600;color:#99a;letter-spacing:.3px;flex-shrink:0}
.content{flex:1;overflow-y:auto;padding:12px 16px 8px;-webkit-overflow-scrolling:touch;display:none}
.content.active{display:block}
.tab-bar{
  display:flex;background:#13162a;
  border-top:1px solid rgba(255,255,255,.06);
  flex-shrink:0;
  padding-bottom:env(safe-area-inset-bottom);
}
.tab{
  flex:1;padding:13px 8px;text-align:center;
  font-size:13px;font-weight:500;color:#445;
  background:none;border:none;cursor:pointer;
  font-family:inherit;position:relative;
  transition:color .2s;
}
.tab.active{color:#dde}
.tab.active::after{
  content:'';position:absolute;top:0;left:25%;right:25%;
  height:2px;background:#4f8cff;border-radius:0 0 1px 1px;
}

/* === Start Screen === */
.start-btn{
  width:130px;height:130px;border-radius:65px;
  background:#131630;border:2px solid #4f8cff40;
  color:#4f8cff;font-size:15px;font-weight:600;
  cursor:pointer;display:flex;flex-direction:column;
  align-items:center;justify-content:center;gap:10px;
  transition:all .15s;font-family:inherit;
}
.start-btn:active{transform:scale(.93);border-color:#4f8cff}
.start-btn svg{width:40px;height:40px}
.start-hint{color:#445;font-size:12px;margin-top:24px;text-align:center;line-height:1.7}
.error-msg{color:#e74c3c;font-size:13px;margin-top:16px;text-align:center;line-height:1.6}

/* === Card === */
.card{background:#161929;border-radius:14px;padding:18px;margin-bottom:10px}

/* === Check Mode === */
.check-note{text-align:center}
.check-kana{font-size:44px;font-weight:800;line-height:1.1}
.check-name{font-size:14px;color:#778;margin-top:6px}
.check-positions{display:flex;justify-content:center;gap:6px;flex-wrap:wrap;margin:10px 0 8px}
.pos-pill{display:inline-flex;align-items:center;gap:5px;padding:5px 12px;border-radius:16px;font-size:14px;font-weight:600}
.pos-dot{width:8px;height:8px;border-radius:4px;flex-shrink:0}
.check-judgment{text-align:center;font-size:17px;font-weight:600;margin:6px 0;min-height:26px}
.check-cents{text-align:center;font-size:12px;color:#556;margin:4px 0}
.check-freq{text-align:center;font-size:32px;font-weight:800;line-height:1;margin:8px 0 4px}
.check-pos{text-align:center;font-size:18px;font-weight:700;margin:6px 0;min-height:26px}
.pos-low{color:#f5a623}
.pos-piano{color:#2ecc71}
.pos-high{color:#4f8cff}
.pos-out{color:#e74c3c}
.pos-silent{color:#334}
.no-sound{color:#445;font-size:16px;text-align:center;padding:36px 0}
#staffCanvas,#zoneBarCanvas{display:block;margin:0 auto}

/* === Reference Tone Button === */
.ref-tone-btn{
  display:flex;align-items:center;justify-content:center;gap:8px;
  margin:8px auto 0;padding:10px 20px;border-radius:12px;
  background:#12152a;border:1.5px solid #222540;
  color:#778;font-size:13px;font-weight:500;cursor:pointer;
  font-family:inherit;transition:all .15s;
}
.ref-tone-btn.playing{border-color:#4f8cff;color:#4f8cff}
.ref-tone-btn:active{transform:scale(.95)}

/* === Practice Mode === */
.practice-controls{display:flex;align-items:center;justify-content:space-between;margin-bottom:8px}
.rec-indicator{display:flex;align-items:center;gap:6px;font-size:14px;font-weight:600;color:#e74c3c}
.rec-dot{width:10px;height:10px;border-radius:50%;background:#e74c3c;animation:pulse 1s infinite}
@keyframes pulse{0%,100%{opacity:1}50%{opacity:.3}}
.rec-time{font-size:14px;color:#99a;font-variant-numeric:tabular-nums}
.practice-btn{
  padding:8px 18px;border-radius:10px;font-size:14px;font-weight:600;
  cursor:pointer;font-family:inherit;transition:all .15s;border:none;
}
.practice-btn:active{transform:scale(.95)}
.btn-stop{background:#e74c3c;color:#fff}
.btn-start{background:#2ecc71;color:#fff}
.mini-staff-wrap{margin:6px 0}
#miniStaffCanvas{display:block;margin:0 auto}
#liveTimelineCanvas{display:block;margin:0 auto;touch-action:none}

/* === Review Mode === */
.review-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:8px}
.review-back{
  padding:6px 14px;border-radius:8px;background:none;
  border:1px solid #222540;color:#778;font-size:13px;
  cursor:pointer;font-family:inherit;
}
.summary-bar{display:flex;height:28px;border-radius:14px;overflow:hidden;margin-bottom:12px}
.summary-seg{display:flex;align-items:center;justify-content:center;font-size:11px;font-weight:600;min-width:30px}
#reviewTimelineCanvas{display:block;margin:0 auto;touch-action:none}
.detail-popup{
  display:none;position:fixed;z-index:100;
  background:#1c2038;border:1px solid #2a2d44;border-radius:12px;
  padding:14px;min-width:180px;box-shadow:0 8px 32px rgba(0,0,0,.5);
}
.detail-popup.show{display:block}
.detail-popup .dp-title{font-size:15px;font-weight:700;margin-bottom:6px}
.detail-popup .dp-row{font-size:13px;color:#99a;margin:3px 0}

/* === Settings === */
.setting-group{margin-bottom:16px}
.setting-label{font-size:14px;color:#99a;margin-bottom:8px;font-weight:600}
.setting-options{display:flex;gap:8px}
.setting-opt{
  flex:1;padding:10px 6px;border-radius:12px;
  font-size:13px;font-weight:500;line-height:1.4;
  background:#12152a;border:1.5px solid #222540;
  color:#556;cursor:pointer;text-align:center;
  transition:all .15s;font-family:inherit;
}
.setting-opt.active{border-color:#4f8cff;background:#4f8cff15;color:#4f8cff}
.history-list{display:flex;flex-direction:column;gap:6px}
.history-item{
  display:flex;align-items:center;justify-content:space-between;
  background:#12152a;border-radius:10px;padding:12px 14px;
  position:relative;overflow:hidden;
}
.history-info{font-size:13px;color:#99a}
.history-info .hi-date{color:#dde;font-weight:500}
.history-delete{
  padding:6px 12px;border-radius:8px;background:#e74c3c20;
  border:1px solid #e74c3c40;color:#e74c3c;font-size:12px;
  cursor:pointer;font-family:inherit;
}
.history-mini-bar{display:flex;height:6px;border-radius:3px;overflow:hidden;margin-top:4px;width:100%}
.history-empty{color:#445;font-size:14px;text-align:center;padding:24px 0}
</style>
</head>
<body>
<div id="app">

  <!-- Start Screen -->
  <div id="startScreen">
    <div style="color:#445;font-size:11px;margin-bottom:20px;letter-spacing:2px;font-weight:600">INTONATION ZONE</div>
    <button class="start-btn" id="startBtn">
      <svg viewBox="0 0 24 24" fill="none">
        <path d="M12 2a3 3 0 0 0-3 3v6a3 3 0 0 0 6 0V5a3 3 0 0 0-3-3z" fill="#4f8cff"/>
        <path d="M17.5 11c0 2.76-2.24 5-5.5 5s-5.5-2.24-5.5-5H5c0 3.53 2.61 6.43 6 6.92V21h2v-3.08c3.39-.49 6-3.39 6-6.92h-1.5z" fill="#4f8cff"/>
      </svg>
      スタート
    </button>
    <p class="start-hint">マイクへのアクセスを許可してください</p>
    <p class="error-msg" id="errorMsg" style="display:none"></p>
  </div>

  <!-- Main App -->
  <div id="mainApp">
    <div class="header">音程練習チューナー</div>

    <!-- Check Mode -->
    <div class="content active" id="checkMode">
      <div class="card">
        <div id="checkNoSound" class="no-sound">音を出してください</div>
        <div id="checkDetected" style="display:none">
          <div class="check-note">
            <div class="check-kana" id="checkKana"></div>
            <div class="check-name" id="checkName"></div>
          </div>
          <div class="check-positions" id="checkPositions"></div>
          <div class="check-freq" id="checkFreq"></div>
          <div class="check-pos" id="checkPos"></div>
          <div class="check-cents" id="checkCentsText"></div>
        </div>
      </div>
      <div class="card">
        <canvas id="staffCanvas"></canvas>
      </div>
      <div class="card">
        <canvas id="zoneBarCanvas"></canvas>
      </div>
      <div style="text-align:center">
        <button class="ref-tone-btn" id="refToneBtn">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor"><polygon points="5,3 19,12 5,21"/></svg>
          基準音を鳴らす
        </button>
      </div>
    </div>

    <!-- Practice Mode -->
    <div class="content" id="practiceMode">
      <div id="practiceIdle">
        <div class="card" style="text-align:center;padding:32px 18px">
          <p style="color:#99a;font-size:15px;margin-bottom:16px">録音しながら音程を記録します</p>
          <button class="practice-btn btn-start" id="recStartBtn">録音スタート</button>
        </div>
      </div>
      <div id="practiceRecording" style="display:none">
        <div class="practice-controls">
          <div class="rec-indicator"><span class="rec-dot"></span>REC</div>
          <div class="rec-time" id="recTime">00:00</div>
          <button class="practice-btn btn-stop" id="recStopBtn">停止</button>
        </div>
        <div class="card mini-staff-wrap">
          <canvas id="miniStaffCanvas"></canvas>
        </div>
        <div class="card">
          <canvas id="liveTimelineCanvas"></canvas>
        </div>
      </div>
      <div id="practiceReview" style="display:none">
        <div class="review-header">
          <button class="review-back" id="reviewBackBtn">戻る</button>
          <span style="color:#99a;font-size:13px" id="reviewDuration"></span>
        </div>
        <div class="summary-bar" id="summaryBar"></div>
        <div class="card">
          <canvas id="reviewTimelineCanvas"></canvas>
        </div>
        <div style="text-align:center;margin-top:8px">
          <span style="color:#556;font-size:11px">スワイプ: スクロール / ピンチ: ズーム / タップ: 詳細</span>
        </div>
      </div>
    </div>

    <!-- Settings Mode -->
    <div class="content" id="settingsMode">
      <div class="card">
        <div class="setting-group">
          <div class="setting-label">基準ピッチ</div>
          <div class="setting-options" id="pitchOptions"></div>
        </div>
        <div class="setting-group">
          <div class="setting-label">判定の厳しさ</div>
          <div class="setting-options" id="strictOptions"></div>
        </div>
      </div>
      <div class="card">
        <div class="setting-label">練習履歴</div>
        <div class="history-list" id="historyList"></div>
      </div>
    </div>

    <!-- Tab Bar -->
    <div class="tab-bar">
      <button class="tab active" data-mode="check">確認</button>
      <button class="tab" data-mode="practice">練習</button>
      <button class="tab" data-mode="settings">設定</button>
    </div>
  </div>
</div>

<!-- Detail Popup -->
<div class="detail-popup" id="detailPopup">
  <div class="dp-title" id="dpTitle"></div>
  <div class="dp-row" id="dpTime"></div>
  <div class="dp-row" id="dpCents"></div>
  <div class="dp-row" id="dpZone"></div>
  <div class="dp-row" id="dpJudge"></div>
</div>

<script>
(function(){
'use strict';

// ===== roundRect polyfill =====
if(typeof CanvasRenderingContext2D.prototype.roundRect==='undefined'){
  CanvasRenderingContext2D.prototype.roundRect=function(x,y,w,h,r){
    if(typeof r==='number') r=[r];
    var tl=r[0]||0;
    this.moveTo(x+tl,y);
    this.arcTo(x+w,y,x+w,y+h,tl);
    this.arcTo(x+w,y+h,x,y+h,tl);
    this.arcTo(x,y+h,x,y,tl);
    this.arcTo(x,y,x+w,y,tl);
    this.closePath();
  };
}

// ===== CONFIGURATION =====
var CFG = {
  a4: 442,
  strictness: 'normal' // 'easy' | 'normal' | 'strict'
};

var STRICT_TOLERANCE = { easy: 14, normal: 7, strict: 3 };
var PITCHES = [440, 441, 442, 443];

// ===== MIDI-BASED NOTE SYSTEM =====
var KANA = ['ド','ド\u266F','レ','レ\u266F','ミ','ファ','ファ\u266F','ソ','ソ\u266F','ラ','ラ\u266F','シ'];
var NAMES = ['C','C\u266F','D','D\u266F','E','F','F\u266F','G','G\u266F','A','A\u266F','B'];
var STAFF_BASE = [0,0,1,1,2,3,3,4,4,5,5,6]; // staff position within octave
var IS_SHARP = [false,true,false,true,false,false,true,false,true,false,true,false];
var OPEN_MIDS = [55,62,69,76]; // G3,D4,A4,E5
var STR_KEYS = ['G','D','A','E'];
var STR_COLORS_ARR = ['#4f8cff','#f5a623','#e74c3c','#2ecc71'];
var STR_NAMES_ARR = ['G線','D線','A線','E線'];
var RANGE_BUFFER = 5; // cents buffer beyond JI/Pyth

// JI / Pythagorean cent offsets from ET per interval
var INTERVALS = [
  {name:'ユニゾン',   ji:  0, pyth:  0},
  {name:'短2度',     ji: 12, pyth:-10},
  {name:'長2度',     ji:  4, pyth:  4},
  {name:'短3度',     ji: 16, pyth: -6},
  {name:'長3度',     ji:-14, pyth:  8},
  {name:'完全4度',   ji: -2, pyth: -2},
  {name:'増4度/減5度', ji:-10, pyth: 12},
  {name:'完全5度',   ji:  2, pyth:  2},
  {name:'短6度',     ji: 14, pyth: -8},
  {name:'長6度',     ji:-16, pyth:  6},
  {name:'短7度',     ji: -4, pyth: -4},
  {name:'長7度',     ji:-12, pyth: 10}
];

function midiInfo(midi){
  var pc=((midi%12)+12)%12;
  var oct=Math.floor(midi/12)-1;
  return {midi:midi,pc:pc,oct:oct,kana:KANA[pc],name:NAMES[pc],sharp:IS_SHARP[pc],freq:midiToFreqET(midi)};
}
function staffPos(midi){
  var pc=((midi%12)+12)%12;
  var oct=Math.floor(midi/12)-1;
  return (oct-4)*7+STAFF_BASE[pc]-2;
}
function getStringIdx(midi){
  for(var i=OPEN_MIDS.length-1;i>=0;i--){if(midi>=OPEN_MIDS[i])return i;}
  return 0;
}
function getInterval(midi){
  return (midi-OPEN_MIDS[getStringIdx(midi)])%12;
}
function getRange(midi){
  var iv=getInterval(midi);
  var data=INTERVALS[iv];
  var lo=Math.min(0,data.ji,data.pyth)-RANGE_BUFFER;
  var hi=Math.max(0,data.ji,data.pyth)+RANGE_BUFFER;
  var et=midiToFreqET(midi);
  return {lo:lo,hi:hi,loHz:et*Math.pow(2,lo/1200),hiHz:et*Math.pow(2,hi/1200),
    etHz:et,ji:data.ji,pyth:data.pyth,ivName:data.name};
}

function refreshTuning() {
  // All frequencies computed on-the-fly from CFG.a4
}

// ===== STATE =====
var audioCtx=null, analyser=null, audioBuf=null;
var isRunning=false, curMode='check';
var smoothPitch=0, silCnt=0;
var lastMidi=-1, lastCentsFromET=null, lastJudgment=null;

// Staff / zone bar canvas contexts
var staffCtx=null, zoneBarCtx=null, miniStaffCtx=null;
var sW=0, sH=0, zbW=0, zbH=0, msW=0, msH=0;

// Reference tone
var refOsc=null, refGain=null, refPlaying=false;

// Practice mode state
var recState='idle'; // 'idle' | 'recording' | 'review'
var recStartTime=0, recEvents=[], recTimerId=null;
var liveCtx=null, liveW=0, liveH=0;
var reviewCtx=null, reviewW=0, reviewH=0;
// Review viewport
var rvOffset=0, rvZoom=1, rvTotalDuration=0;
// Touch state for review
var touchState={dragging:false,pinching:false,startX:0,startOffset:0,
  pinchDist:0,pinchZoom:0,tapStart:0,tapX:0,tapY:0};

// IndexedDB
var db=null;
var DB_NAME='ZoneTunerSessions', DB_VER=1, STORE='sessions', MAX_SESSIONS=30;

// ===== YIN ALGORITHM =====
function yin(buf, sr) {
  var th=0.15, half=Math.floor(buf.length/2);
  var tMin=Math.floor(sr/3000), tMax=Math.min(Math.ceil(sr/170), half);
  if(tMin<1) tMin=1;
  var diff=new Float32Array(half);
  for(var t=0;t<tMax;t++){
    var s=0;
    for(var i=0;i<half;i++){var d=buf[i]-buf[i+t];s+=d*d;}
    diff[t]=s;
  }
  var cm=new Float32Array(half);cm[0]=1;var run=0;
  for(var t=1;t<tMax;t++){run+=diff[t];cm[t]=diff[t]*t/run;}
  var est=-1;
  for(var t=tMin;t<tMax;t++){
    if(cm[t]<th){
      while(t+1<tMax&&cm[t+1]<cm[t])t++;
      est=t;break;
    }
  }
  if(est<0){
    // fallback: global minimum
    var minVal=Infinity;
    for(var t=tMin;t<tMax;t++){
      if(cm[t]<minVal){minVal=cm[t];est=t;}
    }
    if(minVal>0.4) return -1;
  }
  // parabolic interpolation
  var bt=est;
  if(est>tMin&&est<tMax-1){
    var s0=cm[est-1],s1=cm[est],s2=cm[est+1];
    var dn=2*(s0-2*s1+s2);
    if(dn!==0) bt=est+(s0-s2)/dn;
  }
  return sr/bt;
}

// ===== HELPERS =====
function rms(buf){var s=0;for(var i=0;i<buf.length;i++)s+=buf[i]*buf[i];return Math.sqrt(s/buf.length);}
function centsCalc(f,t){return 1200*Math.log2(f/t);}
function freqToMidi(f){return 69+12*Math.log2(f/CFG.a4);}
function midiToFreqET(m){return CFG.a4*Math.pow(2,(m-69)/12);}

// Detect MIDI from frequency (G3-G6 range)
function detectMidi(f){
  var midi=Math.round(freqToMidi(f));
  if(midi<55||midi>91) return -1;
  return midi;
}

// Calculate cents from ET for a given frequency
function centsFromET(f){
  var midi=Math.round(freqToMidi(f));
  var etFreq=midiToFreqET(midi);
  return centsCalc(f,etFreq);
}

// Full judgment pipeline
function judgeNote(f){
  var midi=detectMidi(f);
  if(midi<0) return null;
  var range=getRange(midi);
  var cfe=centsFromET(f);
  var tol=STRICT_TOLERANCE[CFG.strictness];
  var judgment;
  if(cfe>=range.lo&&cfe<=range.hi){
    judgment='green';
  }else{
    var distToZone=Math.min(Math.abs(cfe-range.lo),Math.abs(cfe-range.hi));
    judgment=distToZone<=tol?'yellow':'red';
  }
  var zoneCenter=(range.lo+range.hi)/2;
  var strIdx=getStringIdx(midi);
  return {
    midi:midi,
    openStr:STR_KEYS[strIdx],
    strIdx:strIdx,
    semitones:getInterval(midi),
    zoneLo:range.lo,
    zoneHi:range.hi,
    ivName:range.ivName,
    centsFromET:cfe,
    zoneCenter:zoneCenter,
    deviation:cfe-zoneCenter,
    judgment:judgment,
    ji:range.ji,
    pyth:range.pyth
  };
}

// ===== CANVAS HELPERS =====
function dprCanvas(canvas,w,h){
  var dpr=window.devicePixelRatio||1;
  canvas.style.width=w+'px';
  canvas.style.height=h+'px';
  canvas.width=Math.round(w*dpr);
  canvas.height=Math.round(h*dpr);
  var ctx=canvas.getContext('2d');
  ctx.scale(dpr,dpr);
  return ctx;
}

// ===== AUDIO INIT =====
async function startAudio(){
  var errEl=document.getElementById('errorMsg');
  try{
    if(location.protocol!=='https:'&&location.hostname!=='localhost'&&location.hostname!=='127.0.0.1'&&location.hostname!==''){
      errEl.textContent='HTTPS環境が必要です。';errEl.style.display='block';return;
    }
    if(!navigator.mediaDevices||!navigator.mediaDevices.getUserMedia){
      errEl.textContent='このブラウザはマイク入力に対応していません。';errEl.style.display='block';return;
    }
    var AC=window.AudioContext||window.webkitAudioContext;
    if(!AC){errEl.textContent='Web Audio API非対応';errEl.style.display='block';return;}
    audioCtx=new AC();
    await audioCtx.resume();
    var stream=await navigator.mediaDevices.getUserMedia({
      audio:{echoCancellation:false,noiseSuppression:false,autoGainControl:false}
    });
    var src=audioCtx.createMediaStreamSource(stream);
    analyser=audioCtx.createAnalyser();
    analyser.fftSize=4096;
    src.connect(analyser);
    audioBuf=new Float32Array(analyser.fftSize);
    isRunning=true;
    document.getElementById('startScreen').style.display='none';
    document.getElementById('mainApp').classList.add('visible');
    initCanvases();
    openDB();
    tick();
  }catch(e){
    errEl.textContent=e.name==='NotAllowedError'
      ?'マイクへのアクセスが拒否されました。設定から許可してください。'
      :'マイク初期化失敗: '+e.message;
    errEl.style.display='block';
  }
}

// ===== MAIN LOOP =====
function tick(){
  if(!isRunning)return;
  try{
    analyser.getFloatTimeDomainData(audioBuf);
    var r=rms(audioBuf);
    if(r<0.01){
      silCnt++;
      if(silCnt>15){smoothPitch=0;update(null);}
    }else{
      silCnt=0;
      var f=yin(audioBuf,audioCtx.sampleRate);
      if(f>170&&f<3000){
        if(smoothPitch===0||Math.abs(centsCalc(f,smoothPitch))>80) smoothPitch=f;
        else smoothPitch=smoothPitch*0.7+f*0.3;
        update(smoothPitch);
      }
    }
  }catch(e){}
  requestAnimationFrame(tick);
}

function update(f){
  if(curMode==='check') updCheck(f);
  else if(curMode==='practice'&&recState==='recording') updPractice(f);
}

// ===== CHECK MODE UPDATE =====
function updCheck(f){
  var ns=document.getElementById('checkNoSound');
  var dt=document.getElementById('checkDetected');
  if(f===null){
    ns.style.display='block';dt.style.display='none';
    lastMidi=-1;lastJudgment=null;lastCentsFromET=null;
    drawStaff(-1);drawZoneBar(null,null);return;
  }
  ns.style.display='none';dt.style.display='block';
  var result=judgeNote(f);
  if(!result){drawStaff(-1);drawZoneBar(null,null);return;}
  var midi=result.midi;
  lastMidi=midi;
  lastCentsFromET=result.centsFromET;
  lastJudgment=result.judgment;
  var info=midiInfo(midi);

  // Note name — color by string
  var strColor=STR_COLORS_ARR[result.strIdx];
  document.getElementById('checkKana').textContent=info.kana;
  document.getElementById('checkKana').style.color=strColor;
  document.getElementById('checkName').textContent=info.name+info.oct;

  // String pill
  var sc=STR_COLORS_ARR[result.strIdx];
  var h='<span class="pos-pill" style="background:'+sc+'18;border:1px solid '+sc+'30">';
  h+='<span class="pos-dot" style="background:'+sc+'"></span>';
  h+='<span style="color:'+sc+'">'+STR_NAMES_ARR[result.strIdx]+'</span></span>';
  h+='<span style="color:#556;font-size:12px;margin-left:8px">'+result.ivName+'</span>';
  document.getElementById('checkPositions').innerHTML=h;

  // Hz display (large, colored by position)
  var cfe=result.centsFromET;
  var posText,posClass;
  if(result.judgment==='green'){
    if(cfe-result.zoneCenter<-2){posText='低め';posClass='pos-low';}
    else if(cfe-result.zoneCenter>2){posText='高め';posClass='pos-high';}
    else{posText='ピアノ寄り';posClass='pos-piano';}
  }else if(result.judgment==='yellow'){
    posText=cfe<result.zoneLo?'↑ もう少し高く':'↓ もう少し低く';
    posClass='pos-low';
  }else{
    posText=cfe<result.zoneLo?'↑ 低い':'↓ 高い';
    posClass='pos-out';
  }

  var freqEl=document.getElementById('checkFreq');
  freqEl.textContent=f.toFixed(1)+' Hz';
  freqEl.className='check-freq '+posClass;
  var posEl=document.getElementById('checkPos');
  posEl.textContent=posText;
  posEl.className='check-pos '+posClass;

  // Cents
  document.getElementById('checkCentsText').textContent=(cfe>=0?'+':'')+cfe.toFixed(1)+' cent';

  drawStaff(midi);
  drawZoneBar(result,cfe);
}

// ===== STAFF DRAWING =====
var LS=14,HS=7;
function staffY(pos,bly){return bly-pos*HS;}

function setupStaff(){
  var c=document.getElementById('staffCanvas');
  var pw=c.parentElement.clientWidth-36;
  sW=Math.max(pw,200);sH=190;
  staffCtx=dprCanvas(c,sW,sH);
  drawStaff(lastMidi);
}

function drawStaff(midi){
  var ctx=staffCtx;if(!ctx)return;
  ctx.clearRect(0,0,sW,sH);
  var sl=50,sr=sW-16;
  var bly=sH*0.72;
  ctx.strokeStyle='#2a2d44';ctx.lineWidth=1;
  for(var i=0;i<5;i++){
    var y=bly-i*LS;
    ctx.beginPath();ctx.moveTo(sl,y);ctx.lineTo(sr,y);ctx.stroke();
  }
  drawClef(ctx,sl,bly);
  if(midi<0)return;
  var sp=staffPos(midi);
  var info=midiInfo(midi);
  var nx=(sl+sr)/2+8;
  var ny=staffY(sp,bly);
  var nr=HS*1.3;
  // ledger lines
  ctx.strokeStyle='#3a3d55';ctx.lineWidth=1;
  if(sp<0){
    for(var p=-2;p>=sp-(sp%2===0?0:1);p-=2){
      var ly=staffY(p,bly);
      ctx.beginPath();ctx.moveTo(nx-nr*2,ly);ctx.lineTo(nx+nr*2,ly);ctx.stroke();
    }
  }
  if(sp>8){
    for(var p=10;p<=sp+(sp%2===0?0:1);p+=2){
      var ly=staffY(p,bly);
      ctx.beginPath();ctx.moveTo(nx-nr*2,ly);ctx.lineTo(nx+nr*2,ly);ctx.stroke();
    }
  }
  // accidental
  if(info.sharp){
    drawSharp(ctx,nx-nr-10,ny,LS,'#aab');
  }
  // note head — color by string
  var headCol=STR_COLORS_ARR[getStringIdx(midi)];
  ctx.save();
  ctx.translate(nx,ny);ctx.rotate(-0.3);
  ctx.beginPath();ctx.ellipse(0,0,nr,nr*0.72,0,0,Math.PI*2);
  ctx.fillStyle=headCol;ctx.fill();
  ctx.restore();
  // stem
  var sh=LS*3.5;
  ctx.strokeStyle=headCol;ctx.lineWidth=1.5;
  ctx.beginPath();
  if(sp<4){ctx.moveTo(nx+nr*0.9,ny);ctx.lineTo(nx+nr*0.9,ny-sh);}
  else{ctx.moveTo(nx-nr*0.9,ny);ctx.lineTo(nx-nr*0.9,ny+sh);}
  ctx.stroke();
}

function drawClef(ctx,sl,bly){
  var fs=LS*5.8;
  ctx.save();
  ctx.font=fs+'px Times,serif';
  ctx.fillStyle='#3a4060';
  ctx.textBaseline='alphabetic';
  var gLineY=bly-LS;
  var tx=sl+4;
  var ty=gLineY+fs*0.36;
  var m=ctx.measureText('\uD834\uDD1E');
  if(m.width>2){ctx.fillText('\uD834\uDD1E',tx,ty);}
  else{
    ctx.font='bold '+(LS*1.5)+'px serif';
    ctx.fillStyle='#334';ctx.textBaseline='middle';ctx.textAlign='center';
    ctx.fillText('G',sl+20,gLineY);
  }
  ctx.restore();
}

function drawSharp(ctx,x,y,ls,color){
  ctx.save();
  ctx.strokeStyle=color;
  ctx.lineWidth=1.3;
  ctx.beginPath();
  ctx.moveTo(x-3,y-ls*0.6);ctx.lineTo(x-3,y+ls*0.6);
  ctx.moveTo(x+3,y-ls*0.6);ctx.lineTo(x+3,y+ls*0.6);
  ctx.stroke();
  ctx.lineWidth=2.2;
  ctx.beginPath();
  ctx.moveTo(x-6,y-ls*0.18+1);ctx.lineTo(x+6,y-ls*0.18-1);
  ctx.moveTo(x+6,y+ls*0.18-1);ctx.lineTo(x-6,y+ls*0.18+1);
  ctx.stroke();
  ctx.restore();
}

// ===== ZONE BAR DRAWING =====
function setupZoneBar(){
  var c=document.getElementById('zoneBarCanvas');
  var pw=c.parentElement.clientWidth-36;
  zbW=Math.max(pw,200);zbH=115;
  zoneBarCtx=dprCanvas(c,zbW,zbH);
  drawZoneBar(null,null);
}

function drawZoneBar(result,cfe){
  var ctx=zoneBarCtx;if(!ctx)return;
  var w=zbW,h=zbH;
  ctx.clearRect(0,0,w,h);
  var mx=24,ml=mx,mr=w-mx,mw=mr-ml;
  var cy=h*0.40,bh=4;

  // bar background
  ctx.fillStyle='#1a1d32';
  ctx.beginPath();ctx.roundRect(ml,cy-bh/2,mw,bh,[bh/2]);ctx.fill();

  // ticks
  for(var t=-50;t<=50;t+=10){
    var x=ml+mw*(t+50)/100;
    var th=t===0?18:6;
    ctx.strokeStyle=t===0?'#667':'#262940';
    ctx.lineWidth=t===0?1.5:1;
    ctx.beginPath();ctx.moveTo(x,cy-th/2);ctx.lineTo(x,cy+th/2);ctx.stroke();
  }

  // Zone highlight (if we have zone data)
  if(result&&result.zoneLo!==undefined){
    var zl=ml+mw*(result.zoneLo+50)/100;
    var zr=ml+mw*(result.zoneHi+50)/100;
    ctx.fillStyle='rgba(46,204,113,0.12)';
    ctx.beginPath();ctx.roundRect(zl,cy-20,zr-zl,40,[4]);ctx.fill();
    // zone boundary lines
    ctx.strokeStyle='#2ecc7140';ctx.lineWidth=1;
    ctx.beginPath();ctx.roundRect(zl,cy-20,zr-zl,40,[4]);ctx.stroke();

    // JI / ET / Pythagorean markers
    var refs=[
      {off:result.ji,label:'純正律',col:'#f5a623'},
      {off:0,label:'ET',col:'#778'},
      {off:result.pyth,label:'ピタゴラス',col:'#4f8cff'}
    ];
    // Draw lines for all markers
    for(var i=0;i<refs.length;i++){
      var rx=ml+mw*(refs[i].off+50)/100;
      ctx.strokeStyle=refs[i].col;ctx.lineWidth=1.5;ctx.globalAlpha=0.7;
      ctx.beginPath();ctx.moveTo(rx,cy-14);ctx.lineTo(rx,cy+14);ctx.stroke();
      ctx.globalAlpha=1;
    }
    // Draw labels with collision avoidance
    var labels=refs.map(function(r){
      return {x:ml+mw*(r.off+50)/100,label:r.label,col:r.col,y:cy+17};
    }).sort(function(a,b){return a.x-b.x;});
    var minGap=36;
    for(var i=1;i<labels.length;i++){
      if(Math.abs(labels[i].x-labels[i-1].x)<minGap){
        labels[i].y=labels[i-1].y+11;
      }
    }
    ctx.font='9px -apple-system,sans-serif';ctx.textAlign='center';ctx.textBaseline='top';
    for(var i=0;i<labels.length;i++){
      ctx.globalAlpha=0.6;ctx.fillStyle=labels[i].col;
      ctx.fillText(labels[i].label,labels[i].x,labels[i].y);
    }
    ctx.globalAlpha=1;
    // Zone label
    ctx.fillStyle='#556';ctx.font='11px -apple-system,sans-serif';
    ctx.textAlign='center';ctx.textBaseline='bottom';
    ctx.fillText(result.ivName+' (幅'+(result.zoneHi-result.zoneLo)+'c)',ml+mw/2,cy-24);
  } else {
    // Default: show a generic zone
    var gw=mw*0.14;
    ctx.fillStyle='rgba(46,204,113,0.08)';
    ctx.beginPath();ctx.roundRect(ml+mw/2-gw/2,cy-16,gw,32,[3]);ctx.fill();
  }

  // labels
  ctx.fillStyle='#445';ctx.font='11px -apple-system,sans-serif';
  ctx.textBaseline='top';
  ctx.textAlign='left';ctx.fillText('\u266D 低い',ml,h*0.78);
  ctx.textAlign='right';ctx.fillText('\u266F 高い',mr,h*0.78);

  if(cfe===null||cfe===undefined)return;

  // indicator dot
  var cl=Math.max(-50,Math.min(50,cfe));
  var ix=ml+mw*(cl+50)/100;
  var col=result.judgment==='green'?'#2ecc71':result.judgment==='yellow'?'#f5a623':'#e74c3c';

  // glow
  var g=ctx.createRadialGradient(ix,cy,0,ix,cy,22);
  g.addColorStop(0,col+'55');g.addColorStop(1,col+'00');
  ctx.fillStyle=g;ctx.fillRect(ix-22,cy-22,44,44);

  // dot
  ctx.beginPath();ctx.arc(ix,cy,7,0,Math.PI*2);
  ctx.fillStyle=col;ctx.fill();
  ctx.beginPath();ctx.arc(ix-1.5,cy-2,2.5,0,Math.PI*2);
  ctx.fillStyle='rgba(255,255,255,0.25)';ctx.fill();
}

// ===== REFERENCE TONE =====
function toggleRefTone(){
  var btn=document.getElementById('refToneBtn');
  if(refPlaying){
    stopRefTone();return;
  }
  if(!audioCtx)return;
  var freq=lastMidi>=0?midiToFreqET(lastMidi):CFG.a4;
  refOsc=audioCtx.createOscillator();
  refGain=audioCtx.createGain();
  refOsc.type='sine';
  refOsc.frequency.value=freq;
  refGain.gain.value=0;
  refOsc.connect(refGain);
  refGain.connect(audioCtx.destination);
  refOsc.start();
  refGain.gain.linearRampToValueAtTime(0.15,audioCtx.currentTime+0.1);
  refPlaying=true;
  btn.classList.add('playing');
  btn.querySelector('svg').innerHTML='<rect x="6" y="4" width="4" height="16"/><rect x="14" y="4" width="4" height="16"/>';
}
function stopRefTone(){
  if(refOsc){
    refGain.gain.linearRampToValueAtTime(0,audioCtx.currentTime+0.1);
    var osc=refOsc;
    setTimeout(function(){osc.stop();},150);
    refOsc=null;refGain=null;
  }
  refPlaying=false;
  var btn=document.getElementById('refToneBtn');
  btn.classList.remove('playing');
  btn.querySelector('svg').innerHTML='<polygon points="5,3 19,12 5,21"/>';
}

// ===== PRACTICE MODE =====
function startRecording(){
  recEvents=[];
  recStartTime=performance.now();
  smoothPitch=0;silCnt=0;
  recState='recording';
  document.getElementById('practiceIdle').style.display='none';
  document.getElementById('practiceRecording').style.display='block';
  document.getElementById('practiceReview').style.display='none';
  setupLiveTimeline();
  setupMiniStaff();
  recTimerId=setInterval(updateRecTime,200);
}

function stopRecording(){
  recState='review';
  if(recTimerId){clearInterval(recTimerId);recTimerId=null;}
  document.getElementById('practiceRecording').style.display='none';
  document.getElementById('practiceReview').style.display='block';
  rvTotalDuration=(performance.now()-recStartTime)/1000;
  if(rvTotalDuration<0.5) rvTotalDuration=0.5;
  document.getElementById('reviewDuration').textContent=
    formatTime(rvTotalDuration*1000);
  rvOffset=0;rvZoom=1;
  showReview();
  saveSession();
}

function backToIdle(){
  recState='idle';
  document.getElementById('practiceIdle').style.display='block';
  document.getElementById('practiceRecording').style.display='none';
  document.getElementById('practiceReview').style.display='none';
}

function updateRecTime(){
  var elapsed=performance.now()-recStartTime;
  document.getElementById('recTime').textContent=formatTime(elapsed);
}
function formatTime(ms){
  var s=Math.floor(ms/1000);
  var m=Math.floor(s/60);s=s%60;
  return (m<10?'0':'')+m+':'+(s<10?'0':'')+s;
}

function updPractice(f){
  if(f===null){drawMiniStaff(-1);return;}
  var result=judgeNote(f);
  if(!result){drawMiniStaff(-1);return;}
  var midi=result.midi;
  var info=midiInfo(midi);
  drawMiniStaff(midi);
  // Record event
  var t=performance.now()-recStartTime;
  recEvents.push({
    time:t,
    freq:f,
    midi:midi,
    noteName:info.kana,
    noteNameWestern:info.name+info.oct,
    centsFromET:result.centsFromET,
    intervalSemitones:result.semitones,
    openString:result.openStr,
    zoneLow:result.zoneLo,
    zoneHigh:result.zoneHi,
    zoneCenter:result.zoneCenter,
    deviation:result.deviation,
    judgment:result.judgment,
    sp:staffPos(midi),
    acc:info.sharp?'\u266F':''
  });
  drawLiveTimeline();
}

// ===== MINI STAFF =====
function setupMiniStaff(){
  var c=document.getElementById('miniStaffCanvas');
  var pw=c.parentElement.clientWidth-36;
  msW=Math.max(pw,200);msH=100;
  miniStaffCtx=dprCanvas(c,msW,msH);
  drawMiniStaff(null);
}

function drawMiniStaff(midi){
  var ctx=miniStaffCtx;if(!ctx)return;
  ctx.clearRect(0,0,msW,msH);
  var ls=10,hs=5;
  var sl=36,sr=msW-12;
  var bly=msH*0.72;
  ctx.strokeStyle='#2a2d44';ctx.lineWidth=1;
  for(var i=0;i<5;i++){
    var y=bly-i*ls;
    ctx.beginPath();ctx.moveTo(sl,y);ctx.lineTo(sr,y);ctx.stroke();
  }
  // mini clef
  var fs=ls*5.8;
  ctx.save();
  ctx.font=fs+'px Times,serif';ctx.fillStyle='#3a4060';
  ctx.textBaseline='alphabetic';
  var gLineY=bly-ls;
  var m=ctx.measureText('\uD834\uDD1E');
  if(m.width>2){ctx.fillText('\uD834\uDD1E',sl+2,gLineY+fs*0.36);}
  ctx.restore();
  if(midi<0)return;
  var sp=staffPos(midi);
  var info=midiInfo(midi);
  var nx=(sl+sr)/2+6;
  var ny=bly-sp*hs;
  var nr=hs*1.3;
  // ledger
  ctx.strokeStyle='#3a3d55';ctx.lineWidth=1;
  if(sp<0){
    for(var p=-2;p>=sp-(sp%2===0?0:1);p-=2){
      var ly=bly-p*hs;
      ctx.beginPath();ctx.moveTo(nx-nr*2,ly);ctx.lineTo(nx+nr*2,ly);ctx.stroke();
    }
  }
  if(sp>8){
    for(var p=10;p<=sp+(sp%2===0?0:1);p+=2){
      var ly=bly-p*hs;
      ctx.beginPath();ctx.moveTo(nx-nr*2,ly);ctx.lineTo(nx+nr*2,ly);ctx.stroke();
    }
  }
  if(info.sharp){
    drawSharp(ctx,nx-nr-8,ny,ls,'#aab');
  }
  var headCol=STR_COLORS_ARR[getStringIdx(midi)];
  ctx.save();
  ctx.translate(nx,ny);ctx.rotate(-0.3);
  ctx.beginPath();ctx.ellipse(0,0,nr,nr*0.72,0,0,Math.PI*2);
  ctx.fillStyle=headCol;ctx.fill();
  ctx.restore();
  var sh=ls*3.5;
  ctx.strokeStyle=headCol;ctx.lineWidth=1.2;
  ctx.beginPath();
  if(sp<4){ctx.moveTo(nx+nr*0.9,ny);ctx.lineTo(nx+nr*0.9,ny-sh);}
  else{ctx.moveTo(nx-nr*0.9,ny);ctx.lineTo(nx-nr*0.9,ny+sh);}
  ctx.stroke();
}

// ===== LIVE TIMELINE =====
function setupLiveTimeline(){
  var c=document.getElementById('liveTimelineCanvas');
  var pw=c.parentElement.clientWidth-36;
  liveW=Math.max(pw,200);liveH=180;
  liveCtx=dprCanvas(c,liveW,liveH);
}

function drawLiveTimeline(){
  var ctx=liveCtx;if(!ctx)return;
  var w=liveW,h=liveH;
  ctx.clearRect(0,0,w,h);
  var cy=h*0.45;
  var ml=10,mr=w-10,mw=mr-ml;
  var windowSec=10;
  var now=performance.now()-recStartTime;
  var tEnd=now/1000;
  var tStart=tEnd-windowSec;

  // center line
  ctx.strokeStyle='#262940';ctx.lineWidth=1;
  ctx.beginPath();ctx.moveTo(ml,cy);ctx.lineTo(mr,cy);ctx.stroke();

  // ±50c lines
  var scaleY=h*0.35/50;
  ctx.strokeStyle='#1a1d32';ctx.lineWidth=0.5;
  for(var c2=-40;c2<=40;c2+=20){
    if(c2===0)continue;
    var yy=cy-c2*scaleY;
    ctx.beginPath();ctx.moveTo(ml,yy);ctx.lineTo(mr,yy);ctx.stroke();
  }

  // labels
  ctx.fillStyle='#334';ctx.font='10px -apple-system,sans-serif';
  ctx.textAlign='left';ctx.textBaseline='middle';
  ctx.fillText('♯',ml,cy-45*scaleY);
  ctx.fillText('♭',ml,cy+45*scaleY);

  // Draw events in window
  for(var i=recEvents.length-1;i>=0;i--){
    var ev=recEvents[i];
    var t=ev.time/1000;
    if(t<tStart) break;
    if(t>tEnd) continue;
    var x=ml+mw*(t-tStart)/windowSec;
    var y=cy-ev.centsFromET*scaleY;
    y=Math.max(8,Math.min(h-8,y));

    // zone band
    var bandTop=cy-ev.zoneHigh*scaleY;
    var bandBot=cy-ev.zoneLow*scaleY;
    ctx.fillStyle='rgba(46,204,113,0.06)';
    ctx.fillRect(x-3,bandTop,6,bandBot-bandTop);

    // dot
    var col=ev.judgment==='green'?'#2ecc71':ev.judgment==='yellow'?'#f5a623':'#e74c3c';
    ctx.beginPath();ctx.arc(x,y,3,0,Math.PI*2);
    ctx.fillStyle=col;ctx.fill();
  }
}

// ===== REVIEW =====
function showReview(){
  buildSummaryBar();
  setupReviewTimeline();
  drawReviewTimeline();
}

function buildSummaryBar(){
  var total=recEvents.length;
  if(total===0){
    document.getElementById('summaryBar').innerHTML='<div class="summary-seg" style="flex:1;background:#1a1d32;color:#445">データなし</div>';
    return;
  }
  var gc=0,yc=0,rc=0;
  for(var i=0;i<total;i++){
    if(recEvents[i].judgment==='green')gc++;
    else if(recEvents[i].judgment==='yellow')yc++;
    else rc++;
  }
  var gp=Math.round(gc/total*100);
  var yp=Math.round(yc/total*100);
  var rp=100-gp-yp;
  var h='';
  if(gp>0) h+='<div class="summary-seg" style="flex:'+gp+';background:#2ecc7130;color:#2ecc71">'+gp+'%</div>';
  if(yp>0) h+='<div class="summary-seg" style="flex:'+yp+';background:#f5a62330;color:#f5a623">'+yp+'%</div>';
  if(rp>0) h+='<div class="summary-seg" style="flex:'+rp+';background:#e74c3c30;color:#e74c3c">'+rp+'%</div>';
  document.getElementById('summaryBar').innerHTML=h;
}

function setupReviewTimeline(){
  var c=document.getElementById('reviewTimelineCanvas');
  var pw=c.parentElement.clientWidth-36;
  reviewW=Math.max(pw,200);reviewH=200;
  reviewCtx=dprCanvas(c,reviewW,reviewH);
  setupReviewTouch(c);
}

function drawReviewTimeline(){
  var ctx=reviewCtx;if(!ctx)return;
  var w=reviewW,h=reviewH;
  ctx.clearRect(0,0,w,h);
  var cy=h*0.45;
  var ml=10,mr=w-10,mw=mr-ml;
  var visibleSec=rvTotalDuration/rvZoom;
  if(visibleSec<2) visibleSec=2;
  var tStart=rvOffset;
  var tEnd=tStart+visibleSec;
  if(tEnd>rvTotalDuration){tEnd=rvTotalDuration;tStart=tEnd-visibleSec;}
  if(tStart<0)tStart=0;

  // center line
  ctx.strokeStyle='#262940';ctx.lineWidth=1;
  ctx.beginPath();ctx.moveTo(ml,cy);ctx.lineTo(mr,cy);ctx.stroke();

  var scaleY=h*0.35/50;
  // grid lines
  ctx.strokeStyle='#1a1d32';ctx.lineWidth=0.5;
  for(var c2=-40;c2<=40;c2+=20){
    if(c2===0)continue;
    var yy=cy-c2*scaleY;
    ctx.beginPath();ctx.moveTo(ml,yy);ctx.lineTo(mr,yy);ctx.stroke();
  }

  // Time ticks
  var tickInterval=calcTickInterval(visibleSec);
  ctx.fillStyle='#334';ctx.font='10px -apple-system,sans-serif';
  ctx.textAlign='center';ctx.textBaseline='top';
  var firstTick=Math.ceil(tStart/tickInterval)*tickInterval;
  for(var t=firstTick;t<=tEnd;t+=tickInterval){
    var x=ml+mw*(t-tStart)/visibleSec;
    ctx.strokeStyle='#1e2138';ctx.lineWidth=0.5;
    ctx.beginPath();ctx.moveTo(x,0);ctx.lineTo(x,h);ctx.stroke();
    ctx.fillText(formatTimeSec(t),x,h-16);
  }

  // labels
  ctx.fillStyle='#334';ctx.font='10px -apple-system,sans-serif';
  ctx.textAlign='left';ctx.textBaseline='middle';
  ctx.fillText('♯',ml,cy-45*scaleY);
  ctx.fillText('♭',ml,cy+45*scaleY);

  // Events
  var showLabels=visibleSec<30;
  var lastLabelX=-100;
  for(var i=0;i<recEvents.length;i++){
    var ev=recEvents[i];
    var t=ev.time/1000;
    if(t<tStart||t>tEnd) continue;
    var x=ml+mw*(t-tStart)/visibleSec;
    var y=cy-ev.centsFromET*scaleY;
    y=Math.max(8,Math.min(h-24,y));

    // zone band
    var bandTop=cy-ev.zoneHigh*scaleY;
    var bandBot=cy-ev.zoneLow*scaleY;
    ctx.fillStyle='rgba(46,204,113,0.04)';
    ctx.fillRect(x-3,bandTop,6,bandBot-bandTop);

    // dot
    var col=ev.judgment==='green'?'#2ecc71':ev.judgment==='yellow'?'#f5a623':'#e74c3c';
    ctx.beginPath();ctx.arc(x,y,4,0,Math.PI*2);
    ctx.fillStyle=col;ctx.fill();

    // note label
    if(showLabels&&x-lastLabelX>28){
      ctx.fillStyle='#556';ctx.font='9px -apple-system,sans-serif';
      ctx.textAlign='center';ctx.textBaseline='top';
      ctx.fillText(ev.noteName,x,y+7);
      lastLabelX=x;
    }
  }
}

function calcTickInterval(visSec){
  if(visSec<5) return 1;
  if(visSec<15) return 2;
  if(visSec<30) return 5;
  if(visSec<120) return 10;
  return 30;
}

function formatTimeSec(s){
  var m=Math.floor(s/60);
  var sec=Math.floor(s%60);
  return m+':'+(sec<10?'0':'')+sec;
}

// ===== REVIEW TOUCH =====
function setupReviewTouch(canvas){
  canvas.addEventListener('touchstart',onRvTouchStart,{passive:false});
  canvas.addEventListener('touchmove',onRvTouchMove,{passive:false});
  canvas.addEventListener('touchend',onRvTouchEnd,{passive:false});
  // Mouse fallback
  canvas.addEventListener('mousedown',onRvMouseDown);
  canvas.addEventListener('mousemove',onRvMouseMove);
  canvas.addEventListener('mouseup',onRvMouseUp);
}

function onRvTouchStart(e){
  e.preventDefault();
  if(e.touches.length===1){
    touchState.dragging=true;touchState.pinching=false;
    touchState.startX=e.touches[0].clientX;
    touchState.startOffset=rvOffset;
    touchState.tapStart=performance.now();
    touchState.tapX=e.touches[0].clientX;
    touchState.tapY=e.touches[0].clientY;
  } else if(e.touches.length===2){
    touchState.dragging=false;touchState.pinching=true;
    var dx=e.touches[0].clientX-e.touches[1].clientX;
    var dy=e.touches[0].clientY-e.touches[1].clientY;
    touchState.pinchDist=Math.sqrt(dx*dx+dy*dy);
    touchState.pinchZoom=rvZoom;
  }
}

function onRvTouchMove(e){
  e.preventDefault();
  if(touchState.pinching&&e.touches.length===2){
    var dx=e.touches[0].clientX-e.touches[1].clientX;
    var dy=e.touches[0].clientY-e.touches[1].clientY;
    var dist=Math.sqrt(dx*dx+dy*dy);
    rvZoom=touchState.pinchZoom*(dist/touchState.pinchDist);
    rvZoom=Math.max(1,Math.min(rvTotalDuration/2,rvZoom));
    drawReviewTimeline();
  } else if(touchState.dragging&&e.touches.length===1){
    var visibleSec=rvTotalDuration/rvZoom;
    var dx2=e.touches[0].clientX-touchState.startX;
    var secPerPx=visibleSec/reviewW;
    rvOffset=touchState.startOffset-dx2*secPerPx;
    rvOffset=Math.max(0,Math.min(rvTotalDuration-visibleSec,rvOffset));
    drawReviewTimeline();
  }
}

function onRvTouchEnd(e){
  if(touchState.dragging&&!touchState.pinching){
    var dt=performance.now()-touchState.tapStart;
    var dx=e.changedTouches[0].clientX-touchState.tapX;
    var dy=e.changedTouches[0].clientY-touchState.tapY;
    if(dt<200&&Math.sqrt(dx*dx+dy*dy)<10){
      handleTap(e.changedTouches[0].clientX,e.changedTouches[0].clientY);
    }
  }
  touchState.dragging=false;touchState.pinching=false;
}

// Mouse fallback
function onRvMouseDown(e){
  touchState.dragging=true;touchState.startX=e.clientX;touchState.startOffset=rvOffset;
  touchState.tapStart=performance.now();touchState.tapX=e.clientX;touchState.tapY=e.clientY;
}
function onRvMouseMove(e){
  if(!touchState.dragging)return;
  var visibleSec=rvTotalDuration/rvZoom;
  var dx=e.clientX-touchState.startX;
  var secPerPx=visibleSec/reviewW;
  rvOffset=touchState.startOffset-dx*secPerPx;
  rvOffset=Math.max(0,Math.min(rvTotalDuration-visibleSec,rvOffset));
  drawReviewTimeline();
}
function onRvMouseUp(e){
  if(touchState.dragging){
    var dt=performance.now()-touchState.tapStart;
    var dx=e.clientX-touchState.tapX;
    var dy=e.clientY-touchState.tapY;
    if(dt<200&&Math.sqrt(dx*dx+dy*dy)<10){
      handleTap(e.clientX,e.clientY);
    }
  }
  touchState.dragging=false;
}

function handleTap(clientX,clientY){
  var canvas=document.getElementById('reviewTimelineCanvas');
  var rect=canvas.getBoundingClientRect();
  var x=clientX-rect.left;
  var y=clientY-rect.top;
  var ml=10,mw=reviewW-20;
  var visibleSec=rvTotalDuration/rvZoom;
  var tStart=rvOffset;
  var cy=reviewH*0.45;
  var scaleY=reviewH*0.35/50;
  // Find nearest event
  var best=null,bestDist=Infinity;
  for(var i=0;i<recEvents.length;i++){
    var ev=recEvents[i];
    var t=ev.time/1000;
    if(t<tStart||t>tStart+visibleSec) continue;
    var ex=ml+mw*(t-tStart)/visibleSec;
    var ey=cy-ev.centsFromET*scaleY;
    ey=Math.max(8,Math.min(reviewH-24,ey));
    var d=Math.sqrt((x-ex)*(x-ex)+(y-ey)*(y-ey));
    if(d<bestDist){bestDist=d;best=ev;}
  }
  if(best&&bestDist<20){
    showDetailPopup(best,clientX,clientY);
  } else {
    hideDetailPopup();
  }
}

function showDetailPopup(ev,cx,cy){
  var pop=document.getElementById('detailPopup');
  var col=ev.judgment==='green'?'#2ecc71':ev.judgment==='yellow'?'#f5a623':'#e74c3c';
  document.getElementById('dpTitle').textContent=ev.noteName+' ('+ev.noteNameWestern+')';
  document.getElementById('dpTitle').style.color=col;
  document.getElementById('dpTime').textContent='時刻: '+formatTimeSec(ev.time/1000);
  document.getElementById('dpCents').textContent='ET比: '+(ev.centsFromET>=0?'+':'')+ev.centsFromET.toFixed(1)+'c';
  document.getElementById('dpZone').textContent='ゾーン: '+ev.zoneLow+'c 〜 +'+ev.zoneHigh+'c';
  var jText=ev.judgment==='green'?'正解ゾーン内':ev.judgment==='yellow'?'惜しい':'外れ';
  document.getElementById('dpJudge').textContent='判定: '+jText;
  document.getElementById('dpJudge').style.color=col;
  // Position popup
  var pw=pop.offsetWidth||180;
  var ph=pop.offsetHeight||120;
  var px=cx-pw/2;
  var py=cy-ph-12;
  if(px<8)px=8;
  if(px+pw>window.innerWidth-8)px=window.innerWidth-pw-8;
  if(py<8)py=cy+12;
  pop.style.left=px+'px';pop.style.top=py+'px';
  pop.classList.add('show');
  // Auto-hide after 3s
  clearTimeout(pop._timer);
  pop._timer=setTimeout(hideDetailPopup,3000);
}

function hideDetailPopup(){
  document.getElementById('detailPopup').classList.remove('show');
}

// ===== INDEXEDDB =====
function openDB(){
  var req=indexedDB.open(DB_NAME,DB_VER);
  req.onupgradeneeded=function(e){
    var d=e.target.result;
    if(!d.objectStoreNames.contains(STORE)){
      var s=d.createObjectStore(STORE,{keyPath:'id',autoIncrement:true});
      s.createIndex('timestamp','timestamp',{unique:false});
    }
  };
  req.onsuccess=function(e){db=e.target.result;renderHistory();};
  req.onerror=function(){};
}

function saveSession(){
  if(!db||recEvents.length===0)return;
  var gc=0,yc=0,rc=0;
  for(var i=0;i<recEvents.length;i++){
    if(recEvents[i].judgment==='green')gc++;
    else if(recEvents[i].judgment==='yellow')yc++;
    else rc++;
  }
  var total=recEvents.length;
  var session={
    timestamp:Date.now(),
    duration:rvTotalDuration*1000,
    noteCount:total,
    greenPct:Math.round(gc/total*100),
    yellowPct:Math.round(yc/total*100),
    redPct:Math.round(rc/total*100),
    events:recEvents.slice()
  };
  var tx=db.transaction(STORE,'readwrite');
  var store=tx.objectStore(STORE);
  store.add(session);
  tx.oncomplete=function(){enforceMaxSessions();renderHistory();};
}

function enforceMaxSessions(){
  if(!db)return;
  var tx=db.transaction(STORE,'readwrite');
  var store=tx.objectStore(STORE);
  var idx=store.index('timestamp');
  var req=idx.getAll();
  req.onsuccess=function(){
    var all=req.result;
    if(all.length>MAX_SESSIONS){
      all.sort(function(a,b){return a.timestamp-b.timestamp;});
      var toDelete=all.length-MAX_SESSIONS;
      var tx2=db.transaction(STORE,'readwrite');
      var s2=tx2.objectStore(STORE);
      for(var i=0;i<toDelete;i++){s2.delete(all[i].id);}
    }
  };
}

function loadSession(id,cb){
  if(!db)return;
  var tx=db.transaction(STORE,'readonly');
  var store=tx.objectStore(STORE);
  var req=store.get(id);
  req.onsuccess=function(){cb(req.result);};
}

function deleteSession(id){
  if(!db)return;
  var tx=db.transaction(STORE,'readwrite');
  var store=tx.objectStore(STORE);
  store.delete(id);
  tx.oncomplete=function(){renderHistory();};
}

function renderHistory(){
  if(!db){
    document.getElementById('historyList').innerHTML='<div class="history-empty">データベース未接続</div>';
    return;
  }
  var tx=db.transaction(STORE,'readonly');
  var store=tx.objectStore(STORE);
  var idx=store.index('timestamp');
  var req=idx.getAll();
  req.onsuccess=function(){
    var all=req.result;
    all.sort(function(a,b){return b.timestamp-a.timestamp;});
    var list=document.getElementById('historyList');
    if(all.length===0){
      list.innerHTML='<div class="history-empty">練習履歴はありません</div>';
      return;
    }
    list.innerHTML='';
    for(var i=0;i<all.length;i++){
      (function(s){
        var item=document.createElement('div');
        item.className='history-item';
        var d=new Date(s.timestamp);
        var dateStr=(d.getMonth()+1)+'/'+d.getDate()+' '
          +(d.getHours()<10?'0':'')+d.getHours()+':'+(d.getMinutes()<10?'0':'')+d.getMinutes();
        var durStr=formatTime(s.duration);
        item.innerHTML=
          '<div style="flex:1"><div class="history-info"><span class="hi-date">'+dateStr+'</span> '+durStr+' ('+s.noteCount+'音)</div>'+
          '<div class="history-mini-bar">'+
            (s.greenPct>0?'<div style="flex:'+s.greenPct+';background:#2ecc71"></div>':'')+
            (s.yellowPct>0?'<div style="flex:'+s.yellowPct+';background:#f5a623"></div>':'')+
            (s.redPct>0?'<div style="flex:'+s.redPct+';background:#e74c3c"></div>':'')+
          '</div></div>'+
          '<div style="display:flex;gap:6px">'+
            '<button class="history-delete hd-load" style="background:#4f8cff20;border-color:#4f8cff40;color:#4f8cff">表示</button>'+
            '<button class="history-delete">削除</button>'+
          '</div>';
        var btns=item.querySelectorAll('button');
        btns[0].addEventListener('click',function(){
          loadSession(s.id,function(session){
            if(!session)return;
            recEvents=session.events;
            rvTotalDuration=session.duration/1000;
            if(rvTotalDuration<0.5) rvTotalDuration=0.5;
            rvOffset=0;rvZoom=1;
            switchMode('practice');
            recState='review';
            document.getElementById('practiceIdle').style.display='none';
            document.getElementById('practiceRecording').style.display='none';
            document.getElementById('practiceReview').style.display='block';
            document.getElementById('reviewDuration').textContent=formatTime(session.duration);
            setTimeout(showReview,50);
          });
        });
        btns[1].addEventListener('click',function(){
          if(confirm('この履歴を削除しますか？')){deleteSession(s.id);}
        });
        list.appendChild(item);
      })(all[i]);
    }
  };
}

// ===== SETTINGS =====
function renderSettings(){
  // Pitch options
  var pitchDiv=document.getElementById('pitchOptions');
  pitchDiv.innerHTML='';
  PITCHES.forEach(function(p){
    var btn=document.createElement('button');
    btn.className='setting-opt'+(CFG.a4===p?' active':'');
    btn.textContent=p+' Hz';
    btn.addEventListener('click',function(){
      CFG.a4=p;refreshTuning();renderSettings();
      try{localStorage.setItem('zone-tuner-a4',p);}catch(e){}
    });
    pitchDiv.appendChild(btn);
  });
  // Strictness options
  var strictDiv=document.getElementById('strictOptions');
  strictDiv.innerHTML='';
  var strictOpts=[
    {key:'easy',label:'やさしい',desc:'±14c'},
    {key:'normal',label:'ふつう',desc:'±7c'},
    {key:'strict',label:'きびしい',desc:'±3c'}
  ];
  strictOpts.forEach(function(o){
    var btn=document.createElement('button');
    btn.className='setting-opt'+(CFG.strictness===o.key?' active':'');
    btn.innerHTML=o.label+'<br><span style="color:#556;font-size:11px">'+o.desc+'</span>';
    btn.addEventListener('click',function(){
      CFG.strictness=o.key;renderSettings();
      try{localStorage.setItem('zone-tuner-strict',o.key);}catch(e){}
    });
    strictDiv.appendChild(btn);
  });
}

// ===== CANVAS SETUP =====
function initCanvases(){
  setupStaff();
  setupZoneBar();
}

// ===== MODE / TAB SWITCHING =====
function switchMode(mode){
  curMode=mode;
  document.getElementById('checkMode').classList.toggle('active',mode==='check');
  document.getElementById('practiceMode').classList.toggle('active',mode==='practice');
  document.getElementById('settingsMode').classList.toggle('active',mode==='settings');
  document.querySelectorAll('.tab').forEach(function(t){t.classList.toggle('active',t.dataset.mode===mode);});
  if(mode==='check'){
    setTimeout(function(){setupStaff();setupZoneBar();},30);
  }
  if(mode==='practice'&&recState==='recording'){
    setTimeout(function(){setupLiveTimeline();setupMiniStaff();},30);
  }
  if(mode==='settings'){
    renderSettings();
    renderHistory();
  }
  // Stop ref tone when leaving check
  if(mode!=='check'&&refPlaying) stopRefTone();
  // Hide popup
  hideDetailPopup();
}

// ===== LOAD SETTINGS =====
function loadSettings(){
  try{
    var a4=parseInt(localStorage.getItem('zone-tuner-a4'));
    if(a4>=440&&a4<=443){CFG.a4=a4;refreshTuning();}
    var s=localStorage.getItem('zone-tuner-strict');
    if(s&&STRICT_TOLERANCE[s])CFG.strictness=s;
  }catch(e){}
}

// ===== INIT =====
loadSettings();
document.getElementById('startBtn').addEventListener('click',startAudio);
document.querySelectorAll('.tab').forEach(function(t){
  t.addEventListener('click',function(){switchMode(t.dataset.mode);});
});
document.getElementById('refToneBtn').addEventListener('click',toggleRefTone);
document.getElementById('recStartBtn').addEventListener('click',startRecording);
document.getElementById('recStopBtn').addEventListener('click',stopRecording);
document.getElementById('reviewBackBtn').addEventListener('click',backToIdle);
window.addEventListener('resize',function(){
  if(!isRunning)return;
  if(curMode==='check'){setupStaff();setupZoneBar();}
  if(curMode==='practice'){
    if(recState==='recording'){setupLiveTimeline();setupMiniStaff();}
    if(recState==='review'){setupReviewTimeline();drawReviewTimeline();}
  }
});
// Dismiss popup on outside tap
document.addEventListener('click',function(e){
  if(!document.getElementById('detailPopup').contains(e.target)&&
     e.target!==document.getElementById('reviewTimelineCanvas')){
    hideDetailPopup();
  }
});
// iOS AudioContext resume
document.addEventListener('visibilitychange',function(){
  if(audioCtx&&!document.hidden) audioCtx.resume();
});
document.addEventListener('touchstart',function(){
  if(audioCtx&&audioCtx.state==='suspended') audioCtx.resume();
},{passive:true});

})();
</script>
</body>
</html>
